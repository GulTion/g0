<!DOCTYPE html>
<html>
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6EBTM9J4LK"></script>
<script src="../g.js"></script>
    <title>cg::58469</title>
    <link rel="stylesheet" href="../c.css">
</head>
<body>
    <br><br>
    <div id = "content">
    <div id="container">
    <div id="mf">
        <a href="#" class="nonewtab" d-g="g">g</a> | 
        <a href="#" class="nonewtab" d-g="x">x</a> | 
        <a href="#" class="nonewtab" d-g="w">w</a> | 
        <a href="#" class="nonewtab" d-g="">all</a>
    </div>
    <input type="text" id="mi" placeholder="/">
    </div>

<table id="mt">
  <tr class="header">
    <th class="tbytes">Bytes</th>
    <th class="tlang">Lang</th>
    <th class="ttime">Time</th>
    <th class="tlink">Link</th>
  </tr>
<tr d-ix="0"><td>062</td><td>Pip l</td><td>160422T045934Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/78233#78233">DLosc</a></td></tr>
<tr d-ix="1"><td>133</td><td>JavaScript Node.js</td><td>220402T044905Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/245879#245879">l4m2</a></td></tr>
<tr d-ix="2"><td>414</td><td>Python 3</td><td>150922T184046Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/58481#58481">uno20001</a></td></tr>
<tr d-ix="3"><td>065</td><td>Pyth</td><td>150922T195021Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/58492#58492">orlp</a></td></tr>
<tr d-ix="4"><td>154</td><td>Python 3</td><td>150922T192124Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/58489#58489">orlp</a></td></tr>
<tr d-ix="5"><td>094</td><td>Perl 5 MListUtil=pairmap n</td><td>201222T013504Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/216730#216730">Xcali</a></td></tr>
<tr d-ix="6"><td>198</td><td>ES6</td><td>160116T012227Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/69514#69514">Neil</a></td></tr>
<tr d-ix="7"><td>152</td><td>Mathematica</td><td>151026T094242Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/61796#61796">LLlAMnYP</a></td></tr>
<tr d-ix="8"><td>057</td><td>CJam</td><td>150923T061946Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/58513#58513">Dennis</a></td></tr>
<tr d-ix="9"><td>827</td><td>Java</td><td>150924T030218Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/58559#58559">Programm</a></td></tr>
<tr d-ix="10"><td>148</td><td>SageMath</td><td>150922T232819Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/58501#58501">Jarmex</a></td></tr>
<tr d-ix="11"><td>172</td><td>Perl</td><td>150922T205748Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/58497#58497">Jarmex</a></td></tr>
<tr d-ix="12"><td>284</td><td>Javascript ES6</td><td>150922T201124Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/58494#58494">DankMeme</a></td></tr>
<tr d-ix="13"><td>366</td><td>JavaScript ES6</td><td>150922T185106Z</td><td><a href="https://codegolf.stackexchange.com/questions/58469/molecules-to-atoms/58484#58484">styletro</a></td></tr>
</table>
<div id="pu0" class="pu"><h1><a href="https://github.com/dloscutoff/pip" rel="nofollow noreferrer">Pip</a> <code>-l</code>, <s>85</s> <s>77</s> 62 bytes</h1>
<p>Takes the formula as a command-line argument, and uses the <code>-l</code> flag for proper output formatting.</p>
<pre><code>_.&quot;: &quot;.(_N Y(VaRl:XU+KXL`&quot;&amp;&quot;`RXI`X&amp;`R`[\d&quot;][(&quot;]`{aJ'.}l))MUQy
</code></pre>
<p><a href="https://tio.run/##K8gs@P8/Xk/JSkFJTyPeTyFSIywxKMcqIlTbO8InQUlNKSEowjMhQi0hKCE6JkUpNlpDKTahOtFLXa82R1PTNzSw8v///875xhpuqRrOfppmmkb/dXMA" rel="nofollow noreferrer">Try it online!</a></p>
<p>The main trick is to transform the formula via regex replacements into a Pip expression. This, when eval'd, will do the repetition and resolve parentheses for us. We then post-process a bit to get the atom counts and format everything correctly.</p>
<p>Ungolfed, with comments:</p>
<pre><code>                        a is command-line arg (implicit)
l:`[A-Z][a-z]*`         Regex matching element symbols
aR: l `&quot;&amp;&quot;`             Replace each symbol in a with symbol wrapped in quotes
aR: XI `X&amp;`             Add X before each number (XI is a regex matching integers)
aR: `[\d&quot;][(&quot;]` {aJ'.}  Insert . between a digit or &quot; and a ( or &quot;
Y (Va)@l                Eval result, findall matches of l, and yank that list into y
_.&quot;: &quot;.(_Ny) M UQy      Map function to y uniquified:
                        Each element, concatenated with &quot;: &quot;, concatenated with
                        the count of that element in y
                        Print that list, one element per line (implicit, -l flag)
</code></pre>
<p>Here's how the input <code>Co3(Fe(CN)6)2</code> is transformed:</p>
<pre><code>Co3(Fe(CN)6)2
&quot;Co&quot;3(&quot;Fe&quot;(&quot;C&quot;&quot;N&quot;)6)2
&quot;Co&quot;X3(&quot;Fe&quot;(&quot;C&quot;&quot;N&quot;)X6)X2
&quot;Co&quot;X3.(&quot;Fe&quot;.(&quot;C&quot;.&quot;N&quot;)X6)X2
CoCoCoFeCNCNCNCNCNCNFeCNCNCNCNCNCN
</code></pre>
<p>Then:</p>
<pre><code>[&quot;Co&quot; &quot;Co&quot; &quot;Co&quot; &quot;Fe&quot; &quot;C&quot; &quot;N&quot; &quot;C&quot; &quot;N&quot; &quot;C&quot; &quot;N&quot; &quot;C&quot; &quot;N&quot; &quot;C&quot; &quot;N&quot; &quot;C&quot; &quot;N&quot; &quot;Fe&quot; &quot;C&quot; &quot;N&quot; &quot;C&quot; &quot;N&quot; &quot;C&quot; &quot;N&quot; &quot;C&quot; &quot;N&quot; &quot;C&quot; &quot;N&quot; &quot;C&quot; &quot;N&quot;]
[&quot;Co&quot; &quot;Fe&quot; &quot;C&quot; &quot;N&quot;]
[3 2 12 12]
[&quot;Co: 3&quot; &quot;Fe: 2&quot; &quot;C: 12&quot; &quot;N: 12&quot;]
</code></pre>
</div>
<div id="pu1" class="pu"><h1><a href="https://nodejs.org" rel="nofollow noreferrer">JavaScript (Node.js)</a>, 133 bytes</h1>

<pre class="lang-javascript prettyprint-override"><code>x=&gt;x.replace(/[A-Z][a-z]*|\d+|./g,c=&gt;d=[c&lt;'/'?c&lt;')'?'}':'{':+c?`for(_ in&quot;${Array(-~c)}&quot;)`:`o.${c}=-~o.${c};`]+d,d='',o={})+eval(d)&amp;&amp;o
</code></pre>
<p><a href="https://tio.run/##TY/daoNAEIXvfQqRkN2pf0TTUkw3kgpFCGigd7FSt7trSBAnmBLSGvPqNiY3vRk@5sycw9nxIz@IZrv/tmuUql8xgfUBK@VUuNFK1p/Y/OQ0al9xoaibLex1nnH7N384f0jz7LgbS7C5ZJl4IS4JrxNISDoSkJYEpgiLEhv6qW9rY9Qumob/UPsioDOgCAp0Rq3omH25w6zITWlJRoiFrO3AVEdeUQnjMfYzbfDBr52OpZ4Zr5yuUh88wzKiiR9PntMBl1OaJvR9EG4SjWIf/ChNozvdVl78CF4SD5/o0zdFowSeruc5aP@a03IIA@j/AA" rel="nofollow noreferrer" title="JavaScript (Node.js) – Try It Online">Try it online!</a></p>
<p>Would remain shorter than the existing ones using same old ECMAscript</p>
</div>
<div id="pu2" class="pu"><h1><a href="https://docs.python.org/3/" rel="nofollow noreferrer">Python 3</a>, 414 bytes</h1>
<p>I hope that the order of the result doesn't count.</p>
<pre class="lang-py prettyprint-override"><code>import re
t=input().replace(&quot;[&quot;, '(').replace(&quot;]&quot;, ')')
d={}
p,q=&quot;(\([^\(\)]*\))(\d*)&quot;,&quot;([A-Z][a-z]*)(\d*)&quot;
for i in re.findall(q,t):t = t.replace(i[0]+i[1],i[0]*(1if i[1]==''else int(i[1])))
r=re.findall(p,t)
while len(r)&gt;0:t=t.replace(r[0][0]+r[0][1],r[0][0][1:-1]*(1if r[0][1]==''else int(r[0][1])));r=re.findall(p,t)
for i in re.findall(q[:-5], t):d[i]=d[i]+1if i in d else 1
for i in d:print(i+': '+str(d[i]))
</code></pre>
<p><a href="https://tio.run/##bY9dS8MwFIbv@ytCb3JOm47VoReRCDLw0h9gGmEsKQvENssiouJvr0kpbqI3@XiT8zy8/j0exmEzTfbFjyGSYIoo7OBfI@AqGO92ewOlLBmhQC8SlROkWGjx@VV4dhQldCCfO@hQVR0idLrCkpUg75snJXfNh6qWsOjHQCyxQ7KtejvonXNwZBF5JILEH4mVa1Vb2SqWTxW0tif5KgSlxp1MIkTIASIWQVzAfIIVbwfrDHFmgIB3ax7FmRwSL8PnPfGXu2x50y6i5emXa8mS7vav7t9SkjfXipFUTUurRF7quUb@qMlMbs@jmvswl6opJ7Q@xQB5BHGatuMGHgxsH/EGr74B" rel="nofollow noreferrer" title="Python 3 – Try It Online">Try it online!</a></p>
</div>
<div id="pu3" class="pu"><h1><a href="https://github.com/isaacg1/pyth" rel="nofollow noreferrer">Pyth</a>, <strike>66</strike> 65 bytes</h1>
<pre class="lang-Pyth prettyprint-override"><code>VrSc-`v::z&quot;([A-Z][a-z]*)&quot;&quot;('\\1',),&quot;&quot;,?(\d+)&quot;&quot;*\\1,&quot;`(k))8j&quot;: &quot;_N
</code></pre>
<p><a href="https://tio.run/##K6gsyfj/P6woOFk3oczKqkpJI9pRNyo2OlG3KlZLU0lJQz0mxlBdR1NHSUnHXiMmRRsopgUU0lFK0MjW1LTIUrJSUIr3@//fOd9Ywy1Vw9lP00zTCAA" rel="nofollow noreferrer" title="Pyth – Try It Online">Try it online!</a></p>
<p>Port of my Python answer. Only supports input using regular brackets.</p>
</div>
<div id="pu4" class="pu"><h1><a href="https://docs.python.org/3/" rel="nofollow noreferrer">Python 3</a>, <strike>157</strike> 154 bytes</h1>
<pre class="lang-py prettyprint-override"><code>import re
s=re.sub
f=s(&quot;[()',]&quot;,'',str(eval(s(',?(\d+)',r'*\1,',s('([A-Z][a-z]*)',r'(&quot;\1&quot;,),',input()))))).split()
for c in set(f):print(c+&quot;:&quot;,f.count(c))
</code></pre>
<p><a href="https://tio.run/##HclBC4IwGIDhu79i7LLv0ymY0EGQCKFjPyD1YLbRwLaxzaD@/Fq@t5fHfsLT6CZG9bLGBeJE5jsnKr/dM9l5oAMg4xPljHEfHIj3vIIHxk8wPopEjuVjzRMCg@Fc3qZhLr9TvgvQsaYckypttwC4V3m7qjSZNI4sRGniRQCJrXVKB1gK2lIuq8Vs/0OMsTcNXAT0Vzzi4Qc" rel="nofollow noreferrer" title="Python 3 – Try It Online">Try it online!</a></p>
<p>Only supports input using regular brackets.</p>
<p>Before creating the golfed solution using <code>eval</code> above I created this reference solution, which I found very elegant:</p>
<pre class="lang-py prettyprint-override"><code>import re, collections

parts = filter(bool, re.split('([A-Z][a-z]*|\(|\))', input()))
stack = [[]]
for part in parts:
    if part == '(':
        stack.append([])
    elif part == ')':
        stack[-2].append(stack.pop())
    elif part.isdigit():
        stack[-1].append(int(part) * stack[-1].pop())
    else:
        stack[-1].append([part])

count = collections.Counter()
while stack:
    if isinstance(stack[-1], list):
        stack.extend(stack.pop())
    else:
        count[stack.pop()] += 1

for e, i in count.items():
    print(&quot;{}: {}&quot;.format(e, i))
</code></pre>
</div>
<div id="pu5" class="pu"><h1><a href="https://www.perl.org/" rel="nofollow noreferrer">Perl 5</a> <code>-MList::Util=pairmap -n</code>, 94 bytes</h1>

<pre class="lang-perl prettyprint-override"><code>s/\(([^()]+?)\)(\d)/$1x$2/e&amp;&amp;redo;s/([A-Z][a-z]*)(\d?)/$k{$1}+=$2||1/ge;pairmap{say&quot;$a: $b&quot;}%k
</code></pre>
<p><a href="https://tio.run/##LcxNC4IwHIDxrxKy5L9kza28KCKde/EQXVKDhSOGpsN5qNSv3iro9Fx@PFp2dWCtoTlAdgFceAnOMeQlpog9EKfSdTtZtpGhkG3IucgEeRWLn0i@pBoQm7wY8XFk9CYjLVR3F3ow4ukgEc7Q1ZnmlbXbNaQHOKYrzDF/t7pXbWMs2QdLn/nf7pTpw/DUqzr@LyxpPg" rel="nofollow noreferrer" title="Perl 5 – Try It Online">Try it online!</a></p>
</div>
<div id="pu6" class="pu"><h2>ES6, 198 bytes</h2>

<pre><code>f=s=&gt;(t=s.replace(/(([A-Z][a-z]?)|\(([A-Za-z]+)\))(\d+)/,(a,b,x,y,z)=&gt;(x||y).repeat(z)))!=s?f(t):(m=new Map,s.match(/[A-Z][a-z]?/g).map(x=&gt;m.set(x,-~m.get(x))),[...m].map(([x,y])=&gt;x+": "+y).join`\n`)
</code></pre>

<p>Where <code>\n</code> is a literal newline character.</p>

<p>Ungolfed:</p>

<pre><code>function f(str) {
    // replace all multiple elements with individual copies
    // then replace all groups with copies working outwards
    while (/([A-Z][a-z]?)(\d+)/.test(str) || /\(([A-Za-z]+)\)(\d+)/.test(str)) {
        str = RegExp.leftContext + RegExp.$1.repeat(RegExp.$2) + RegExp.rightContext;
    }
    // count the number of each element in the expansion
    map = new Map;
    str.match(/[A-Z][a-z]?/g).forEach(function(x) {
        if (!map.has(x)) map.set(x, 1);
        else map.set(x, map.get(x) + 1);
    }
    // convert to string
    res = "";
    map.forEach(function(value, key) {
        res += key + ": " + value + "\n";
    }
    return res;
}
</code></pre>
</div>
<div id="pu7" class="pu"><h2>Mathematica, 152 bytes</h2>

<pre><code>f=TableForm@Cases[PowerExpand@Log@ToExpression@StringReplace[#,{a:(_?UpperCaseQ~~___?LowerCaseQ):&gt;"\""&lt;&gt;a&lt;&gt;"\"",b__?DigitQ:&gt;"^"&lt;&gt;b}],a_. Log[b_]:&gt;{b,a}]&amp;
</code></pre>

<p>The above defines a function <code>f</code> which takes a string as input. The function takes the string and wraps each element name into quotes and adds an infix exponentiation operator before each number, then interprets the string as an expression:</p>

<pre><code>"YBa2Cu3O7" -&gt; ""Y""Ba"^2"Cu"^3"O"^7" -&gt; "Y" "Ba"^2 "Cu"^3 "O"^7
</code></pre>

<p>Then it takes the logarithm of that and expands it out (mathematica doesn't care, what to take the logarithm of :)):</p>

<pre><code>Log["Y" "Ba"^2 "Cu"^3 "O"^7] -&gt; Log["Y"] + 2 Log["Ba"] + 3 Log["Cu"] + 7 Log["O"]
</code></pre>

<p>and then it finds all occurrences of multiplication of a <code>Log</code> by a number and parses it into the form of <code>{log-argument, number}</code> and outputs those in a table. Some examples:</p>

<pre><code>f@"K4(ON(SO3)2)2"
K   4
N   2
O   14
S   4


f@"(CH3)3COOC(CH3)3"
C   8
H   18
O   2


f@"Co3(Fe(CN)6)2"
C   12
Co  3
Fe  2
N   12
</code></pre>
</div>
<div id="pu8" class="pu"><h1>CJam, <s>59</s> 57 bytes</h1>

<pre><code>q{:Ci32/")("C#-"[ ] aC~* Ca C+"S/=~}%`La`-S%$e`{~": "@N}/
</code></pre>

<p>Try it online in the <a href="http://cjam.aditsu.net/#code=q%7B%3ACi32%2F%22)(%22C%23-%22%5B%20%5D%20aC~*%20Ca%20C%2B%22S%2F%3D~%7D%25%60La%60-S%25%24e%60%7B~%22%3A%20%22%40N%7D%2F&amp;input=Co3(Fe(CN)6)2" rel="noreferrer">CJam interpreter</a>.</p>

<h3>How it works</h3>

<pre><code>q             e# Read all input from STDIN.
{             e# For each character:
  :Ci         e#   Save it in C and cast to integer.
  32/         e#   Divide the code point by 32. This pushes
              e#   2 for uppercase, 3 for lowercase and 1 for non-letters.
  ")("C#      e#   Find the index of C in that string. (-1 if not found.)
  -           e#   Subtract. This pushes 0 for (, 1 for ), 2 for digits,
              e#   3 for uppercase letters and 4 for lowercase letters.

 "[ ] aC~* Ca C+"

 S/           e#   Split it at spaces into ["[" "]" "aC~*" "Ca" "C+"].
 =~           e#   Select and evaluate the corresponding chunk.
              e#     (   : [    : Begin an array.
              e#     )   : ]    : End an array.
              e#     0-9 : aC~* : Wrap the top of the stack into an array
              e#                  and repeat that array eval(C) times.
              e#     A-Z : Ca   : Push "C".
              e#     a-z : C+   : Append C to the string on top of the stack.
}%            e#
`             e# Push a string representation of the resulting array.
              e# For input (Au(CH)2)2, this pushes the string
              e# [[["Au" [["C" "H"] ["C" "H"]]] ["Au" [["C" "H"].["C" "H"]]]]]
La`           e# Push the string [""].
-             e# Remove square brackets and double quotes from the first string.
S%            e# Split the result at runs of spaces.
$e`           e# Sort and perform run-length encoding.
{             e# For each pair [run-length string]:
  ~           e#   Dump both on the stack.
  ": "        e#   Push that string.
  @N          e#   Rotate the run-length on top and push a linefeed.
}/            e#
</code></pre>
</div>
<div id="pu9" class="pu"><h1>Java, 827 bytes</h1>

<pre><code>import java.util.*;class C{String[]x=new String[10];public static void main(String[]a){new C(a[0]);}C(String c){I p=new I();int[]d=d(c,p);for(int i=0;i&lt;10;i++)if(x[i]!=null)System.out.println(x[i]+": "+d[i]);}int[]d(String c,I p){int[]f;int i,j;Vector&lt;int[]&gt;s=new Vector();while(p.v&lt;c.length()){char q=c.charAt(p.v);if(q=='(')s.add(d(c,p.i()));if(q==')')break;if(q&gt;='A'&amp;&amp;q&lt;='Z'){f=new int[10];char[]d=new char[]{c.charAt(p.v),0};i=1;if(c.length()-1&gt;p.v){d[1]=c.charAt(p.v+1);if(d[1]&gt;='a'&amp;&amp;d[1]&lt;='z'){i++;p.i();}}String h=new String(d,0,i);i=0;for(String k:x){if(k==null){x[i]=h;break;}if(k.equals(h))break;i++;}f[i]++;s.add(f);}if(q&gt;='0'&amp;&amp;q&lt;='9'){j=c.charAt(p.v)-'0';f=s.get(s.size()-1);for(i=0;i&lt;10;)f[i++]*=j;}p.i();}f=new int[10];for(int[]w:s){j=0;for(int k:w)f[j++]+=k;}return f;}class I{int v=0;I i(){v++;return this;}}}
</code></pre>

<p><a href="https://github.com/ProgrammerDan/molecules-golf" rel="nofollow" title="Git repository">Git repository w/ ungolfed source</a> (not perfect parity, ungolfed supports multi-character numbers).</p>

<p>Been a while, figured I'd give Java some representation. Definitely not going to win any awards :).</p>
</div>
<div id="pu10" class="pu"><h1><a href="https://en.wikipedia.org/wiki/SageMath" rel="nofollow">SageMath</a>, <s>156</s> 148 bytes</h1>

<pre><code>import re
i=input()
g=re.sub
var(re.findall("[A-Z][a-z]?",i))
print g("(\d+).(\S+)\D*",r"\2: \1\n",`eval(g("(\d+)",r"*\1",g("([A-Z(])",r"+\1",i)))`)
</code></pre>

<p>Try it online <a href="https://cloud.sagemath.com/projects/f313957c-5f64-4f65-9c4d-b95b3ca2952e/files/2015-09-22-223459.sagews" rel="nofollow">here</a> (hopefully link will work, might need an online account)</p>

<p>Note: If trying online, you will need to replace <code>input()</code> with the string (e.g. <code>"(CH3)3COOC(CH3)3"</code>)</p>

<h3>Explanation</h3>

<p>Sage allows you to simplify algebraic expressions, providing they are in the right format (see 'symbolic manipulation' of <a href="http://doc.sagemath.org/html/en/constructions/polynomials.html" rel="nofollow">this</a> link). The regexes inside the eval() basically serve to get the input string into the right format, for example something like:</p>

<pre><code>+(+C+H*3)*3+C+O+O+C+(+C+H*3)*3
</code></pre>

<p><code>eval()</code> will then simplify this to: <code>8*C + 18*H + 2*O</code>, and then it's just a matter of formatting the output with another regex substitution.</p>
</div>
<div id="pu11" class="pu"><h1>Perl, <s>177</s> 172 bytes</h1>

<p>171 bytes code + 1 byte command line parameter</p>

<p>Ok, so I may have got a <em>little</em> carried away with regex on this one...</p>

<pre><code>s/(?&gt;[A-Z][a-z]?)(?!\d)/$&amp;1/g;while(s/\(([A-Z][a-z]?)(\d+)(?=\w*\W(\d+))/$2.($3*$4).$1/e||s/([A-Z][a-z]?)(\d*)(\w*)\1(\d*)/$1.($2+$4).$3/e||s/\(\)\d+//g){};s/\d+/: $&amp;\n/g
</code></pre>

<p>Usage example:</p>

<pre><code>echo "(CH3)3COOC(CH3)3" | perl -p entry.pl
</code></pre>
</div>
<div id="pu12" class="pu"><h1>Javascript (ES6), <s>286</s> 284</h1>

<p>Not that much shorter than the other ES6 one but I gave it my best. Note: this will error out if you give it an empty string or most invalid inputs. Also expects all groups to have a count of more than 1 (ie, no <code>CO[OH]</code>). If this breaks any challenge rules, let me know.</p>

<pre><code>a=&gt;(b=[],c={},a.replace(/([A-Z][a-z]*)(?![0-9a-z])/g, "$11").match(/[A-Z][a-z]*|[0-9]+|[\[\(]/g).reverse().map(d=&gt;(d*1==d&amp;&amp;b.push(d*1),d.match(/\(|\[/)&amp;&amp;b.pop(),d.match(/[A-Z]/)&amp;&amp;eval('e=b.reduce((f,g)=&gt;f*g,1),c[d]=c[d]?c[d]+e:e,b.pop()'))),eval('g="";for(x in c)g+=x+`: ${c[x]}\n`'))
</code></pre>

<p>Uses a stack-based approach. First, it preprocesses the string to add <code>1</code> to any element without a number, ie <code>Co3(Fe(CN)6)2</code> becomes <code>Co3(Fe1(C1N1)6)2</code>. Then it loops through in reverse order and accumulates element counts.</p>

<pre><code>a=&gt;(
  // b: stack, c: accumulator
  b=[], c={},

  // adds the 1 to every element that doesn't have a count
  a.replace(/([A-Z][a-z]*)(?![0-9a-z])/g, "$11")

    // gathers a list of all the elements, counts, and grouping chars
    .match(/[A-Z][a-z]*|[0-9]+|[\[\(]/g)

    // loops in reverse order
    .reverse().map(d=&gt;(

       // d*1 is shorthand here for parseInt(d)
       // d*1==d: true only if d is a number
       // if it's a number, add it to the stack
       d * 1 == d &amp;&amp; b.push(d * 1),

       // if there's an opening grouping character, pop the last item
       // the item being popped is that group's count which isn't needed anymore
       d.match(/\(|\[/) &amp;&amp; b.pop(),

       // if it's an element, update the accumulator
       d.match(/[A-Z]/) &amp;&amp; eval('

         // multiplies out the current stack
         e = b.reduce((f, g)=&gt; f * g, 1),

         // if the element exists, add to it, otherwise create an index for it
         c[d] = c[d] ? c[d] + e : e,

         // pops this element's count to get ready for the next element
         b.pop()
       ')
  )),

  // turns the accumulator into an output string and returns the string
  eval('
    g="";

    // loops through each item of the accumulator and adds it to the string
    // for loops in eval always return the last statement in the for loop
    // which in this case evaluates to g
    for(x in c)
      g+=x+`: ${c[x]}\n`
  ')
)
</code></pre>

<p><a href="http://jsfiddle.net/5dp3ng0e/" rel="nofollow">Fiddle</a></p>
</div>
<div id="pu13" class="pu"><h1>JavaScript ES6, 366 bytes</h1>

<pre><code>function f(i){function g(a,b,c){b=b.replace(/[[(]([^[(\])]+?)[\])](\d*)/g,g).replace(/([A-Z][a-z]?)(\d*)/g,function(x,y,z){return y+((z||1)*(c||1))});return(b.search(/[[(]/)&lt;0)?b:g(0,b)}return JSON.stringify(g(0,i).split(/(\d+)/).reduce(function(q,r,s,t){(s%2)&amp;&amp;(q[t[s-1]]=+r+(q[t[s-1]]||0));return q},{})).replace(/["{}]/g,'').replace(/:/g,': ').replace(/,/g,'\n')}
</code></pre>

<p>JS Fiddle:
<a href="https://jsfiddle.net/32tunzkr/1/">https://jsfiddle.net/32tunzkr/1/</a></p>

<p>I'm pretty sure this can be shortened, but I need to get back to work. ;-) </p>
</div>

<table id="st">
<!-- Popups content will be added here -->
</table>

<table id="at">
<!-- Popups content will be added here -->
</table>

</div>





  <div class="footer">
      <b><a class="nonewtab" href="../">GOLFSCORE/</a><a href="https://codegolf.stackexchange.com/questions/58469/">58469</a></b>
  </div>
<div class="footer-space">&nbsp;</div>



<script src="../c.js"> </script>
</body>
</html>




