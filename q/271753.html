<!DOCTYPE html>
<html>
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6EBTM9J4LK"></script>
<script src="../g.js"></script>
    <title>cg::271753</title>
    <link rel="stylesheet" href="../c.css">
</head>
<body>
    <br><br>
    <div id = "content">
    <div id="container">
    <div id="mf">
        <a href="#" class="nonewtab" d-g="g">g</a> | 
        <a href="#" class="nonewtab" d-g="x">x</a> | 
        <a href="#" class="nonewtab" d-g="w">w</a> | 
        <a href="#" class="nonewtab" d-g="">all</a>
    </div>
    <input type="text" id="mi" placeholder="/">
    </div>

<table id="mt">
  <tr class="header">
    <th class="tbytes">Bytes</th>
    <th class="tlang">Lang</th>
    <th class="ttime">Time</th>
    <th class="tlink">Link</th>
  </tr>
<tr d-ix="0"><td>nan</td><td>n < 160</td><td>240314T091655Z</td><td><a href="https://codegolf.stackexchange.com/questions/271753/convert-maximum-values-to-bit-widths/271800#271800">Neil</a></td></tr>
<tr d-ix="1"><td>2040</td><td>Score  13613</td><td>240312T212852Z</td><td><a href="https://codegolf.stackexchange.com/questions/271753/convert-maximum-values-to-bit-widths/271756#271756">Tavian B</a></td></tr>
</table>
<div id="pu0" class="pu"><h1>n &lt; 160, score 11925</h1>

<pre class="lang-c prettyprint-override"><code>#define MAX_TO_WIDTH(x) ((~0ull / 31 * ((x) &gt;&gt; 4 &amp; ~0ull / 31 / (~0ull / 31 &amp; 31)) / (~0ull / 32)) * 5 + (4 - 12 / (3 + (x) % 31)))
</code></pre>
<p><a href="https://tio.run/##hZNha9swEIa/@1fcElakrE1qxwulbgplK2zQMlgyNijFCFmZxTw5SHKaraR/PTvZWRvbSWoSGb1399wr4eMnPGPq53rdTcRMKgG3Vz/i6Zf4@@eP009kSYGQp9Miy2AAQx96uEXt8hJCOIKtwAC2045wobQmBrjvwXt4BySEE/ADFx26LfLelvl0PejBh1TwX7BgmUyk/QNSwVyLuc65MCbXwHOFusyVgd7A68oZBIitefYRWv4pvBlD6HWF1ljZuV7OBbciqWcPKYzHEHQwDckzz3MeWMaLjFkBCLu4AEWd42N4kDbNCwv5QuhZlj@UFjbXVtIcFulEuWsjxP92c@PqCakItFqdhKtzWLUrj2xTZuvWKJ4eO1lTh9PttleTyfXX6aYAu8QTy6zkMTMGK0mN17BYHhzfx9DpVEbwhphKDNi8zvVpVBcCFPr9fkMdhSjv8RYHzl2D4j6nzc1EO0N0NytssRC/n/YS3MM7a/PCQ7zwFZ4/coWNFgd4Z6/whkGLhy0OAF@ie4ijkDRPjE1aHNQC6rUqI8@TysJvJhVZ5DKh8OgBPk7Uwt7dwxgecV7wd7qKypDB2eEpIG6T6572uDMDzM24sQxZYomzbwxOu/us/ldxZkRzhs@fozXunGmhbCqM/MtsA@MeNFto1YTdoXwfPSfi/bEis@e7Kv0qbeWt1v8A" rel="nofollow noreferrer" title="C (clang) – Try It Online">Try it online!</a> <a href="https://tio.run/##hZRtb9owEMff51PcQKMxa6AJGarKg1RtTJvUqdJgWqWqQp5jFqupg2KHh3Xsq7NzYIUkQC0w8v/ufnc2Pv@kKlwzqqEPOn7kUjUYdLtng9tPZ@tqwCdCcvh6fTce3Y5/fPk4@mwvCNj234s0iqAJLRfquESt3wcfarBnaMK@Ww0nQnKih@s6vId3YPvggOsZa8sskfc28yfrZh0@hJw9woxGIhB6CULCNOHTJGZcqTgBFkvURSwV1JtWVUzAQ2yuZheh2ZfAmx74VpUnCUZWBospZ5oHee8WgV4PvAq6IXliWaYGGrE0opoDwrpdkMRUfA5zocM41RDPeDKJ4nlWwvbYMprBIt2W5ths2/1@c2PibXtDIJvZSDibCjfpsi3rEP@XXGkEd4@ZtMrDyX7a6@Fw8G20DcAs46GmWrAxVQoj7RyvUGK2cfw9h0plUwieEJWBwruR57qkkxc8FBqNRkFt@ygfqW3smeoKFHOdtifTOWgih1l@iYX447Sd8QjvsszzT/H8V3hu2wQWUpzgXb7Ca3klHqY4AdxZjxDbvl3cMSYpcVDziFWK7FiWkBqeqJD2LBYBgWcLcBgx4fr@AXrwjP2Cn4tVJzMp7B0WAuK2vmaU250qoKbHlabI4gvsfaWw2821@h/FqOLFHr56sea4U5pwqUOuxG@qCxgzsNg0kUXYPcoPnRdHPD@aRvrqUKS7cVtZKwsfUYtFVP4CZ6KWUtOFE8toCc7dVg3Sp6mzeXZ3r6/Xr7nwB@YMnGj9Dw" rel="nofollow noreferrer" title="Bash – Try It Online">Verify the score!</a></p>
<p>Explanation: The first part masks out the bits corresponding to <code>2⁴</code>, <code>2⁹</code>, <code>2¹⁴</code> etc., then counts just those bits by multiplying by a shifted mask and shifting. This value is multiplied by <code>5</code>. Any remaining bits are extracted via <code>% 31</code> and these are counted in a similar way to @TavianBarnes' answer by adding <code>3</code> and dividing into <code>12</code>.</p>
<p>For specific values of <code>n</code> the score can be reduced by folding the constants.</p>
<h1>n = 128, score 10622</h1>
<pre class="lang-c prettyprint-override"><code>#define MAX_TO_WIDTH(x) ((0x8421084210842108421084210842108ull * ((x) &gt;&gt; 4 &amp; 0x1084210842108421084210842108421ull) &gt;&gt; 123) * 5 + (4 - 12 / (3 + (x) % 31)))
</code></pre>
<p>Can't try it online but <a href="https://tio.run/##hZRtb9owEMff51PcQGtt1gAJGarKg1RtTJvUqdJgWqWqQl5iFqupg2IDYR2fnZ0TVpYEqJUY5R5@97fx@SdT4dZnGoag40cuVdOHfv98dPvpfFsP@ExIDl@v76aT2@mPLx8nn0lKgZB2eum5Tvv4BA2MwtDhEDw4g3Z6KhinLNJxOxQT38M7IB7Y@A0tIB3ziai30HEopdtWAz6E3H@EJYtEIPQahIR5wudJ7HOl4gT8WKJdxFJBo2XVxQxcxBZW4SA0eym8GYBn1XmSYGZtlM65r3lQjEZZgwG4NQxD8syyjAYW@YuIaQ4I6/dBUqP4AlZCh/FCQ7zkySyKV5mE3UZmNINFOpFmIwlxvt/cmHxCcgLNZ2PC2SjMy2VL1iH@UwVpFFePlbQqwun/Za/H49G3yS4Bq0zHmmnhT5lSmEkKvJLEbOH4ewG1Wi4Ed4jJQOFpKXId2isaXDQ0m82Steuh@Yi2qWvUlSjmJO12pnfQRQ@zvAoL8cdpe@cR3mWV553iea/wnK5JLJU4wbt8hddxKzwscQK49x4hdj1SXjEWqXDQ5lKrktmzLCE1PDEhyTIWAYVnC3AYY8L1/QMM4Bn7BZ/2ppe5FPaOHwLidrFmVNudKWCmx5VmyOIp9r5S2O3mWP3L8pni5R6@evEWuHOWcKlDrsRvpksYM1DsIpFl2D2aH3ovgbh/bBHpq0OZTh62sTYWXquWHzH5C@yZWkvNUjuW0Rrsu501WDzN7fwi3t/H7vDMgT@w8sGOtn8B" rel="nofollow noreferrer" title="Bash – Try It Online">Verify the score!</a></p>
<h1>n = 64, score 10473</h1>
<pre class="lang-c prettyprint-override"><code>#define MAX_TO_WIDTH(x) ((0x1084210842108421ull * ((x) &amp; 0x842108421084210ull) &gt;&gt; 59) * 5 + (4 - 12 / (3 + (x) % 31)))
</code></pre>
<p><a href="https://tio.run/##hZN/a9swEIb/96e4JWxIWZvYjhuyuimUrbBBx2DJ2KAUI2RlFvPkYMmpt5LPnp3srK3tJBW2jO/Hc68OHT/lKVM/t9t@LJZSCfh89SNafIm@f/qw@EhKCoS4pedOA//ZVqQpDNCD7jfglk2ni14Kl5dw9o5i1Bm8BRLAKXg@jICM7S/mvYaxRyndjgbwPhH8F6xZKmNp/oBUsMrFKs@40DrLgWcK7TJTGgYjpy@X4CO2IdNDaPVSeDWDwOmLPMfM3nW5EtyIuBk9pjCbgd/DMCQvHcdqYCkvUmYEIOziAhS1ik/gXpokKwxka5Ev0@y@krDrVEWzWKQTZTtFiPft5sbmE1ITaL1bE@5WYV2uOrJJmGlKo3h6rGR0E06fl72az6@/LnYJWCWaG2Ykj5jWmEkavJbE6uD4PYFerxaCHWIq1mCyJtejYdPgo2E4HLaskwDNB7RFvlXXothrs@tMuNdF97OCDgvxh2lPzgO8aZcXHOMFL/C8iU1slTjCm77AG/sdHpY4AnzyHiBOAtI@MRbpcNDmU6eTGTqOVAZ@M6nIOpMxhQcHcFljLsztHczgAecFH3cTVi6Ns8MTQNwu1q7uuDMNzM64NgxZosTZ1xqn3V6r/1mcadGe4fNHb4O7YrlQJhFa/mWmhbELxRa5asNu0XwXPgZi/1iRmvN9mV4dtnE2238" rel="nofollow noreferrer" title="C (clang) – Try It Online">Try it online!</a> <a href="https://tio.run/##hZRtb9owEMff51PcQGtt1gAJKWLlQao6pk3qVGllWqWqQl5ilqipg2IHwjo@OzsnrDQJUIsY5R5@97fj8y8m/Y3LFIxARY9cyKYLg8Hp@Obz6abu8VkgOHy7vJtObqY/v36afCEpBULaqdXuOfarKQlDaKAH3SfQTovONnopjEZw/pFi1Dl8AOKACZYNLSAd/Yp576FjUUo3rQZc@dx9hAULAy9QKwgEzGM@jyOXSxnF4EYC7UEkJDRaRj2YgY3YgkwLodlD4d0QHKPO4xgza@N0zl3FvWJ0h8JwCHYNw5A8MwytgYVuEjLFAWGDAQiqFZ/BMlB@lCiIFjyehdEyk7DdqYymsUgnQu8UIdaP62udT0hOoPmsTThrhXm5bMnKx09RkEZx9VhJySKcvi57eXs7/j7ZJmCV6a1iKnCnTErMJAVeSWK2cPw/g1otF4I7xIQn8TgUuRbtFw02GprNZsnaddB8QNvU1upKFH1stjvT3@ui@1lOhYX4w7Sd8wCvV@U5x3jOGzyrqxNLJY7wem/wOnaFhyWOAHfeA8SuQ8orxiIVDtpsalQy@4YRCAVPLBBkEQUehWcDcGhjzNX9AwzhGfsFf@11P3NJ7B3XB8RtY/WotjuTwHSPS8WQxVPsfSmx2/Wx@p/lMsnLPXzx4i1w5yzmQvlcBn@YKmH0QLFJLMqwezQ/9F8Ccf9YEqqLfZlWHrY21gbem4YbMvEbzJlcCcVSMxLhCsy7rdVLnuZmftPuLlx7dGLBX1i6YIabfw" rel="nofollow noreferrer" title="Bash – Try It Online">Verify the score!</a></p>
</div>
<div id="pu1" class="pu"><h1>Score: <s>13877</s> 13613, <span class="math-container">\$n = 2040\$</span>.</h1>
<p><em>-264 thanks to l4m2</em></p>
<pre class="lang-c prettyprint-override"><code>#define CHUNK(m, mask) (m) / ((m) % mask + 1) / mask % mask
#define INTERP(m) 7 - 86 / ((m) % 255 + 12)
#define MAX_TO_WIDTH(m) (CHUNK(m, 255) * 8 + INTERP(m))
</code></pre>
<hr />
<p>This idea is due to Hallvard B. Furuseth on a <a href="https://groups.google.com/g/comp.lang.c/c/NfedEFBFJ0k/m/9HAqis6IDqcJ" rel="nofollow noreferrer">comp.lang.c post</a> in 2003.  It uses this helper function</p>
<pre class="lang-c prettyprint-override"><code>#define CHUNK(m, mask) (m) / ((m) % mask + 1) / mask % mask
</code></pre>
<p>Which is used to make a repeating sequence like this:</p>
<p><span class="math-container">$$
\begin{aligned}
a_{i,j} &amp; = \texttt{CHUNK}(2^i - 1, 2^j - 1) \\
a_{0,j}, a_{1,j}, a_{2,j}, \ldots &amp; = \underbrace{0, \ldots, 0}_{\text{$j$ times}}, \underbrace{1, \ldots, 1}_{\text{$j$ times}}, \cdots, \underbrace{2^j-2, \ldots, 2^j - 2}_{\text{$j$ times}}, 0, \ldots
\end{aligned}
$$</span></p>
<p>You can play around with it in Python to see:</p>
<pre class="lang-python prettyprint-override"><code>&gt;&gt;&gt; def CHUNK(m, mask):
...     return (m) // ((m) % mask + 1) // mask % mask
... 
&gt;&gt;&gt; def a(i, j):
...     return CHUNK(2**i - 1, 2**j - 1)
... 
&gt;&gt;&gt; [a(i, 2) for n in range(10)]
[0, 0, 1, 1, 2, 2, 0, 0, 1, 1]
&gt;&gt;&gt; [a(i, 3) for n in range(10)]
[0, 0, 0, 1, 1, 1, 2, 2, 2, 3]
&gt;&gt;&gt; [a(i, 4) for n in range(10)]
[0, 0, 0, 0, 1, 1, 1, 1, 2, 2]
&gt;&gt;&gt; [a(n, 5) for n in range(5 * (2**5 - 1))] == \
... [i for i in range(2**5 - 1) for j in range(5)]
True
</code></pre>
<p>This sequence has <span class="math-container">\$j \, (2^j - 1)\$</span> values before it wraps, meaning</p>
<p><span class="math-container">$$
\texttt{CHUNK}(2^i - 1, 2^j - 1) = \lfloor i/j \rfloor \quad \text{for all $i &lt; j \, (2^j - 1)$.}
$$</span></p>
<p>This is almost enough—what we want is <span class="math-container">\$j \, \lfloor i/j \rfloor + (i \bmod j) = i\$</span>.  We can get <span class="math-container">\$(i \bmod j)\$</span> in various ways.  For now, let's fix <span class="math-container">\$j = 8\$</span>.  We know that <span class="math-container">\$2^i \pmod {2^8 - 1}\$</span> will have period 8:</p>
<pre class="lang-python prettyprint-override"><code>&gt;&gt;&gt; [(2**i - 1) % 255 for i in range(16)]
[0, 1, 3, 7, 15, 31, 63, 127, 0, 1, 3, 7, 15, 31, 63, 127]
</code></pre>
<p>And we can brute force a linear interpolation of these that maps them to <code>[0, 1, 2, ...]</code>:</p>
<pre class="lang-python prettyprint-override"><code>&gt;&gt;&gt; [(7 - 86 // ((2**i - 1) % 255 + 12)) for i in range(16)]
[0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7]
</code></pre>
<hr />
<p>The <a href="https://groups.google.com/g/comp.lang.c/c/NfedEFBFJ0k/m/9HAqis6IDqcJ" rel="nofollow noreferrer">original post</a> is more like this:</p>
<pre class="lang-c prettyprint-override"><code>#define CHUNK(m, mask) (m) / ((m) % mask + 1) / mask % mask
#define INTERP(m) 4 - 12 / ((m) % 31 + 3)
#define MAX_TO_WIDTH(m) \
    (CHUNK(m, 0x3fffffffL) * 30 + CHUNK((m) % 0x3fffffff, 31) * 5 + INTERP(m))
</code></pre>
<p>Which would have score: 21477, <span class="math-container">\$n = 30 \cdot (2^{30} - 1) = 32212254690\$</span>.</p>
</div>

<table id="st">
<!-- Popups content will be added here -->
</table>

<table id="at">
<!-- Popups content will be added here -->
</table>

</div>





  <div class="footer">
      <b><a class="nonewtab" href="../">GOLFSCORE/</a><a href="https://codegolf.stackexchange.com/questions/271753/">271753</a></b>
  </div>
<div class="footer-space">&nbsp;</div>



<script src="../c.js"> </script>
</body>
</html>




