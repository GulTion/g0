<!DOCTYPE html>
<html>
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6EBTM9J4LK"></script>
<script src="../g.js"></script>
    <title>cg::189164</title>
    <link rel="stylesheet" href="../c.css">
</head>
<body>
    <br><br>
    <div id = "content">
    <div id="container">
    <div id="mf">
        <a href="#" class="nonewtab" d-g="g">g</a> | 
        <a href="#" class="nonewtab" d-g="x">x</a> | 
        <a href="#" class="nonewtab" d-g="w">w</a> | 
        <a href="#" class="nonewtab" d-g="">all</a>
    </div>
    <input type="text" id="mi" placeholder="/">
    </div>

<table id="mt">
  <tr class="header">
    <th class="tbytes">Bytes</th>
    <th class="tlang">Lang</th>
    <th class="ttime">Time</th>
    <th class="tlink">Link</th>
  </tr>
<tr d-ix="0"><td>1171</td><td>Python3</td><td>240522T202439Z</td><td><a href="https://codegolf.stackexchange.com/questions/189164/complete-the-grid-filling-meander/273249#273249">Ajax1234</a></td></tr>
<tr d-ix="1"><td>185</td><td>JavaScript ES7</td><td>190802T181815Z</td><td><a href="https://codegolf.stackexchange.com/questions/189164/complete-the-grid-filling-meander/189175#189175">Arnauld</a></td></tr>
</table>
<div id="pu0" class="pu"><h1>Python3, 1171 bytes</h1>
<p>Long, but fast.</p>
<pre class="lang-py prettyprint-override"><code>P=[[(1,3)],[(2,4)],[(1,2)],[(2,3)],[(3,4)],[(4,1)],[(1,2),(3,4)],[(2,3),(4,1)]]
M={1:(3,0,-1),3:(1,0,1),2:(4,-1,0),4:(2,1,0)}
E=enumerate
def G(d):
 q=[i for i in d if d[i]]
 while q:
  v=q.pop(0)
  Q,S=[(*v,0,[])],[v]
  for x,y,H,p in Q:
   for j in P[d[(x,y)]-1]:
    if not H or H in j:
     for J in j:
      e,X,Y=M[J];U=(x+X,y+Y)
      if d.get(U,-1)&gt;0 and([]==p or U!=p[-1]):
       if p and U==p[0]:return p+[(x,y)]
       Q+=[(*U,e,p+[(x,y)])];S+=[U]
  q=[*{*q}-{*S}]
def V(d):
 for x,y in d:
  if d[(x,y)]:
   for j in P[d[(x,y)]-1]:
    for J in j:
     e,X,Y=M[J];U=(x+X,y+Y)
     if U not in d:return
     if d[U]==0:continue
     if not any(e in u for u in P[d[U]-1]):return
 return 1
def f(b):
 q=[{(x,y):v for x,r in E(b)for y,v in E(r)}]
 for d in q:
  if(L:=G(d)):
   if len({*L})!=len(d):continue
   return d
  D={}
  for x,y in d:
   if d[(x,y)]==0:
    for I,A in E(P,1):
     T=eval(str(d));T[(x,y)]=I
     if V(T):D[(x,y)]=D.get((x,y),[])+[I]
  if D:
   t=min(map(len,D.values()))
   k=[i for i in D if len(D[i])==t]
   if t==1:
    T=eval(str(d))
    for i in k:T[i]=D[i][0]
    q+=[T]
   else:
    for I in D[k[0]]:T=eval(str(d));T[k[0]]=I;q+=[T]
</code></pre>
<p><a href="https://tio.run/##hVPvT9swEP28/BWGL9itW@VHN6ZUnjSp0yiCCUSDQJ41lcUdgZKkSdpRVf3buzs7CUVMm/qhvnfv7t49O/m6us/S4GNe7HYXQkrq8YApLqnPB@bf434dWzyo8QH32jxvUWRxm1POudh4IaRc3vMYD0LgupDhfgiMHgSMD0IowdPW@SJ0unzSxbTSTqxn5CuNWeiQhZAJmWUFSUiSkpgkMxLLBLqT3/fJXJMFcMhKLPp5llOXQXDJr4SknRUMkwpVrYBsWjzzNT/hOTa6xDIDPmB4IWNJIc1Uz1MmhYPSrCInBDgnyHmwuCk63QeI5jf8VpzLUzWMBH3u3vB195bVSRTc/6UrGqENn1wyTWMqlRA5do4ORC5hJmt6IT9HDomAIl0VFrpaFinJu7XChnjZxTUjrnmbYmp4BWiEHDCus@kstr1N52qrjKXX1tLaCuMnjjWW2gb/deXN8v/aHRpHxkQzye7RZmKQKYQb/szSKkmXuk1gwTRdU41lSzNx2aiJlPGqaVVb45ntZvSufjAbIzpc1ZsWWP0Fshiu@cqGBQNXDCNGYGGdoGehwJdn7wPUzHVKN52zLTsQeAQD9wXXAmI4j8Rm@/LOWnP33cV1WxfH/LMVcgHfRG3mROjVdE7LqkAJw0lTN27NuaYTFo4afGQelgnwrXflWNn7HJmGlXhKUvo0zSlI56M@9F7qkjJm7ufx1Zc1apYdwdfFhKhULb4SwrPyXqtrFzHlj@EE6gQWw5s1uQW8xIk56nmp9xY34@Qj8FT4ZmMDi/HQVu/wYqvsx102LWJagk/vasul7OBiSVpxkvTLfJ5UsJhqBc2SeaUL@i1LNSdlTTj6nh4BySk9Isjh4aHznnxwXBI4eC79FnTND1MuOcaz49ZY4PhkYM8GC8zJlAcvPQn2HZi0D/ExID7EAZTaWU5egHI6oy@7eXgtb2H/73AA8O4P" rel="nofollow noreferrer">Try it online!</a></p>
</div>
<div id="pu1" class="pu"><h1>JavaScript (ES7), <s>&nbsp;236 ... 193&nbsp;</s> 185 bytes</h1>

<p>Outputs by modifying the input matrix.</p>

<pre class="lang-javascript prettyprint-override"><code>m=&gt;(g=(d,x,y,v,r=m[y],h=_=&gt;++r[x]&lt;9?g(d,x,y,v)||h():r[x]=0)=&gt;r&amp;&amp;1/(n=r[x])?x|y|!v?n?g(d='21100--13203-32-21030321'[n*28+d*3+7&amp;31],x+--d%2,y+--d%2,v+=n&lt;7||.5):h():!m[v**.5|0]:0)(0,0,0,0)
</code></pre>

<p><a href="https://tio.run/##ZU/bboMwDH3nK9KHlQQMC0lpt66hT/sKFk2o0JuaUEGFQMu@nZHRrpUmy4p9LrZzzJqs3lSH8yXQZV70W9ErkeCdwDm00EEDlVBpJ2EvPkXi@1XaytXrenejiTF7TJYWFpSIpJpOo2eshQXIujWdmTRrbfXCZVFEaRBEnFEecBawiHLKWeSm2mMvfu5xfzHlkYTWD4L8iUF3fRtf6NXCmDAmS7ttotLG88LYULmkBFP4DdJfivqCBFJIJOgLbUpdl6ciPJU7vMWKkDeUuh/aBeSCK8NtWb1nmz2ui7PVP6pVqLIzrixchcfyoPHgIGQsBz1BPrKT7Mhvx7FrceoglFKYSxgLKh1JHqgY5hDf6NlwLwc2NjEsBo7dGA5D/jOPf7xPHzx2x19rg48tg9kI3FkO14P6Hw" rel="nofollow noreferrer" title="JavaScript (Node.js) â€“ Try It Online">Try it online!</a></p>

<p>(includes some post-processing code to print the result both as a matrix and as a flat list compatible with the <a href="https://observablehq.com/@jrunning/grid-filling-meanders" rel="nofollow noreferrer">visualization tool</a> provided by the OP)</p>

<h2>Results</h2>

<ul>
<li><a href="https://observablehq.com/@jrunning/grid-filling-meanders#5,6,4,3" rel="nofollow noreferrer">Test case #1</a></li>
<li><a href="https://observablehq.com/@jrunning/grid-filling-meanders#5,6,5,6,4,8,3,2,5,7,6,2,4,3,4,3" rel="nofollow noreferrer">Test case #2</a></li>
<li><a href="https://observablehq.com/@jrunning/grid-filling-meanders#5,1,6,5,6,2,5,7,3,2,2,2,2,5,3,2,4,7,8,6,4,1,3,4,3" rel="nofollow noreferrer">Test case #3</a></li>
</ul>

<h2>How?</h2>

<h3>Variables</h3>

<p><span class="math-container">\$g\$</span> is a recursive function taking the current direction <span class="math-container">\$d\$</span>, the current coordinates <span class="math-container">\$(x,y)\$</span> and the number of visited cells <span class="math-container">\$v\$</span>.</p>

<p>The following variables are also defined in the scope of <span class="math-container">\$g\$</span>:</p>

<ul>
<li><p><span class="math-container">\$r\$</span> is the current row of the matrix.</p>

<pre class="lang-javascript prettyprint-override"><code>r = m[y]
</code></pre></li>
<li><p><span class="math-container">\$h\$</span> is a helper function that tries all values from <span class="math-container">\$1\$</span> to <span class="math-container">\$8\$</span> for the current cell and invokes <span class="math-container">\$g\$</span> with each of them. It either stops as soon as <span class="math-container">\$g\$</span> succeeds or sets the current cell back to <span class="math-container">\$0\$</span> if we need to backtrack.</p>

<pre class="lang-javascript prettyprint-override"><code>h = _ =&gt; ++r[x] &lt; 9 ? g(d, x, y, v) || h() : r[x] = 0
</code></pre></li>
</ul>

<h3>Initial checks</h3>

<p>We first make sure that our current location is valid and we load the value of the current cell into <span class="math-container">\$n\$</span>:</p>

<pre class="lang-javascript prettyprint-override"><code>r &amp;&amp; 1 / (n = r[x]) ? ... ok ... : ... failed ...
</code></pre>

<p>We test whether we're back to our starting position, i.e. we're located at <span class="math-container">\$(0,0)\$</span> and we've visited at least a few cells (<span class="math-container">\$v&gt;0\$</span>):</p>

<pre class="lang-javascript prettyprint-override"><code>x | y | !v ? ... no ... : ... yes ...
</code></pre>

<p>For now, let's assume that we're not back to the starting point.</p>

<h3>Looking for a path</h3>

<p>If <span class="math-container">\$n\$</span> is equal to <span class="math-container">\$0\$</span>, we invoke <span class="math-container">\$h\$</span> to try all possible values for this tile.</p>

<p>If <span class="math-container">\$n\$</span> is not equal to <span class="math-container">\$0\$</span>, we try to move to the next tile.</p>

<p>The tile connections are encoded in a lookup table, whose index is computed with <span class="math-container">\$n\$</span> and <span class="math-container">\$d\$</span>, and whose valid entries represent the new values of <span class="math-container">\$d\$</span>.</p>

<pre class="lang-javascript prettyprint-override"><code>d = '21100--13203-32-21030321'[n * 28 + d * 3 + 7 &amp; 31]
</code></pre>

<p>The last 8 entries are invalid and omitted. The other 4 invalid entries are explicitly marked with hyphens.</p>

<p>For reference, below are the decoded table, the compass and the tile-set provided in the challenge:</p>

<pre><code>   | 1 2 3 4 5 6 7 8
---+-----------------
 0 | 0 - - 1 3 - 3 1          1
 1 | - 1 - - 2 0 2 0        0 + 2
 2 | 2 - 1 - - 3 1 3          3
 3 | - 3 0 2 - - 0 2
</code></pre>

<p><img src="https://i.sstatic.net/qKSzJ.png" width="250"></p>

<p>We do a recursive call to <span class="math-container">\$g\$</span> with the new direction and the new coordinates. We add <span class="math-container">\$1/2\$</span> to <span class="math-container">\$v\$</span> if we were on a tile of type <span class="math-container">\$7\$</span> or <span class="math-container">\$8\$</span>, or <span class="math-container">\$1\$</span> otherwise (see the next paragraph).</p>

<pre class="lang-javascript prettyprint-override"><code>g(d, x + --d % 2, y + --d % 2, v += n &lt; 7 || .5)
</code></pre>

<p>If <span class="math-container">\$d\$</span> is invalid, <span class="math-container">\$x\$</span> and <span class="math-container">\$y\$</span> will be set to <em>NaN</em>, forcing the next iteration to fail immediately.</p>

<h3>Validating the path</h3>

<p>Finally, when we're back to <span class="math-container">\$(0,0)\$</span> with <span class="math-container">\$v&gt;0\$</span>, it doesn't necessarily mean that we've found a valid path, as we may have taken a shortcut. We need to check if we've visited the correct number of cells.</p>

<p>Each tile must be visited once, except tiles <span class="math-container">\$7\$</span> and <span class="math-container">\$8\$</span> that must be visited twice. This is why we add only <span class="math-container">\$1/2\$</span> to <span class="math-container">\$v\$</span> when such a tile is visited.</p>

<p>In the end, we must have <span class="math-container">\$v = N^2\$</span>. But it's also worth noting that we can't possibly have <span class="math-container">\$v &gt; N^2\$</span>. So, it's enough to test that we don't have <span class="math-container">\$v &lt; N^2\$</span>, or that the <span class="math-container">\$k\$</span><sup>th</sup> row of the matrix (0-indexed) does not exist, where <span class="math-container">\$k=\lfloor\sqrt{v}\rfloor\$</span>.</p>

<p>Hence the JS code:</p>

<pre class="lang-javascript prettyprint-override"><code>!m[v ** .5 | 0]
</code></pre>

<h3>Formatted source</h3>

<pre class="lang-javascript prettyprint-override"><code>m =&gt; (
  g = (
    d,
    x, y,
    v,
    r = m[y],
    h = _ =&gt; ++r[x] &lt; 9 ? g(d, x, y, v) || h() : r[x] = 0
  ) =&gt;
    r &amp;&amp; 1 / (n = r[x]) ?
      x | y | !v ?
        n ?
          g(
            d = '21100--13203-32-21030321'[n * 28 + d * 3 + 7 &amp; 31],
            x + --d % 2,
            y + --d % 2,
            v += n &lt; 7 || .5
          )
        :
          h()
      :
        !m[v ** .5 | 0]
    :
      0
)(0, 0, 0, 0)
</code></pre>
</div>

<table id="st">
<!-- Popups content will be added here -->
</table>

<table id="at">
<!-- Popups content will be added here -->
</table>

</div>





  <div class="footer">
      <b><a class="nonewtab" href="../">GOLFSCORE/</a><a href="https://codegolf.stackexchange.com/questions/189164/">189164</a></b>
  </div>
<div class="footer-space">&nbsp;</div>



<script src="../c.js"> </script>
</body>
</html>




